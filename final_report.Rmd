---
title: "Final report"
author: "Jamie Montgomery"
output: 
  html_document:
    theme: paper
    toc: true
    toc_float: true
    toc_depth: 2
---

```{r setup, include=FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

library(mapview)
library(tidyverse)
library(sf)
library(leaflet)
library(kableExtra)
library(sp)

tweet_data <- read_csv("data/geotagged_sb_tweets.csv")
```

# Overview

Project summary

Goals:
- 
- 
- 

Findings:


# Data Overview

Twitter data

## Table of data 

Here is a sample of the type of twitter information we obtained.

```{r, echo = FALSE}
kable(sample_n(tweet_data, 10)) %>%
  kable_styling(bootstrap_options = c("striped", "condensed"), font_size = 10, fixed_thead = T)
```

## Caveats

Required crimson hexagon access

## Maps

### Interactive with cluster markers

As you zoom in on the map, clusters will disaggregate. You can click on blue points to see the tweet.


```{r, echo = FALSE}
tweet_sf <- tweet_data %>%
  st_as_sf(coords = c("lon", "lat")) %>%
  st_set_crs(4326)

#map
leaflet(tweet_data) %>%
  # Base groups
  addProviderTiles(providers$CartoDB.Positron) %>%
  # Overlay groups %>%
    addCircleMarkers(data = tweet_data, lng = ~lon, lat = ~lat, popup = ~full_text,
                   radius = 3, stroke = FALSE, fillOpacity = 0.5, clusterOptions = markerClusterOptions())
```

### Tweet density

This is log-transformed. There is a single coordinate that has over 11,000 tweets reported across all years. It is near De La Vina between Islay and Valerio. There is nothing remarkable about this site so I assume it is the default coordinate when people tag "Santa Barbara" generally. The coordinate is 34.4258, -119.714.

```{r, echo = FALSE}
hex_grid <- read_sf("data/sb_area_hexagons.shp")

hex_tweet_count <- hex_grid %>%
  mutate(tweet_count = lengths(st_intersects(hex_grid, tweet_sf)),
         log_tweet_count = log(tweet_count))

log_hex_map <-mapview(hex_tweet_count %>% filter(tweet_count > 0), #remove hexes with no tweets
                 zcol = "log_tweet_count", layer.name = "Tweet count (log)")

log_hex_map@map %>% setView(lng = -119.714, lat = 34.426, zoom = 12)
```

## Identifying tourists and locals

If the user has self-identified their location as somewhere in the Santa Barbara area, they are designated a *local*. This includes Carpinteria, Santa Barbara, Montecito, Goleta, Gaviota and UCSB. For the remainder, we use the number of times they have tweeted from Santa Barbara within a year to designate user type. If someone has tweeted across more than 2 months in the same year from Santa Barbara, they are identified as a local. This is consistent with how [Eric Fischer](https://www.citylab.com/transportation/2015/02/where-do-locals-go-in-major-cities-check-out-this-interactive-world-map/385768/) determined tourists in his work. This is not fool-proof and there are instances were people visit and tweet from Santa Barbara more than two months a year, especially if they are visiting family or live within a couple hours driving distance.

```{r, echo = FALSE}
tweet_data_users <- read_csv("data/geotag_sb_tweets_user_type.csv")

tweet_data_users_sf <- tweet_data_users %>%
  st_as_sf(coords = c("lon", "lat")) %>%
  st_set_crs(4326)
```

There are `r nrow(filter(tweet_data_users, user_type == "tourist"))` tweets from tourists and `r nrow(filter(tweet_data_users, user_type == "local"))` tweets from locals.

The following map shows tweet **log density** by locals (top - blue) and tourists (bottom - red).

```{r, echo = FALSE}

hex_grid <- read_sf("data/sb_area_hexagons.shp")
locals   <- tweet_data_users_sf %>% filter(user_type == "local")
tourists <- tweet_data_users_sf %>% filter(user_type == "tourist")

hex_tweet_count_locals <- hex_grid %>%
  mutate(tweet_count = lengths(st_intersects(hex_grid, locals)),
         log_tweet_count = log(tweet_count))

hex_tweet_count_tourists <- hex_grid %>%
  mutate(tweet_count = lengths(st_intersects(hex_grid, tourists)),
         log_tweet_count = log(tweet_count))

#color palettes
blues = colorRampPalette(c("#DEEBF7", "#08306B"))
reds = colorRampPalette(c("#FEE0D2", "#67000D"))

m1 <- mapview(hex_tweet_count_locals %>% filter(tweet_count > 0), 
        zcol = "log_tweet_count", 
        layer.name = "# tweets by locals (log)",
        col.regions = blues,
        alpha.regions = 0.9,
        legend = FALSE)
m2 <- mapview(hex_tweet_count_tourists %>% filter(tweet_count > 0), 
          zcol = "log_tweet_count", 
          layer.name = "# tweets by tourists (log)",
        col.regions = reds,
        alpha.regions = 0.9, 
        legend = FALSE) 

m3 <- m1@map %>% setView(lng = -119.714, lat = 34.426, zoom = 13)
m4 <- m2@map %>% setView(lng = -119.714, lat = 34.426, zoom = 13)
sync(m3, m4, ncol = 1)
```


## Identifying nature-based tweets

### Applying dictionary

The dictionary is "nature-based" and is a list of words I put together. I had a hard time finding an ontology or lexicon that would fit this project. These are definitely skewed more towards nature and recreation rather than words like "home" or "connection".

```{r, echo = FALSE}
dictionary <- read_csv("data/dictionary.csv")
nature_df <- read_csv("data/tweets_nature_categorized.csv")
dictionary$word
```


Let's look at some examples

```{r}
kable(sample_n(nature_df %>% filter(nature_word == 1), 20)) %>%
  kable_styling(bootstrap_options = c("striped", "condensed"), font_size = 10, fixed_thead = T)
```

# Where are nature-based tweets?

```{r}
nature_sf <- nature_df %>%
  st_as_sf(coords = c("lon", "lat")) %>%
  st_set_crs(4326)

hex_tweet_count_nature <- hex_grid %>%
  mutate(tweet_count = lengths(st_intersects(hex_grid, nature_sf %>% filter(nature_word == 1))),
         log_tweet_count = log(tweet_count))

#color palettes
greens = colorRampPalette(c("#E5F5E0", "#00441B"))

m <- mapview(hex_tweet_count_nature %>% filter(tweet_count > 0), 
        zcol = "log_tweet_count", 
        layer.name = "# Nature tweets (log)",
        col.regions = greens) 

m@map %>% setView(lng = -119.714, lat = 34.426, zoom = 12)
```


# Who is tweeting nature-based tweets?

```{r, echo = FALSE}
nature_df_user_type <- nature_df %>%
    mutate(coords = gsub("\\)|c\\(", "", geo_coordinates)) %>%
    separate(coords, c("lat", "lon"), sep = ", ") %>%
    mutate_at(c("lon", "lat"), as.numeric) %>% 
    st_as_sf(coords = c("lon", "lat")) %>%
    st_set_crs("+init=epsg:4326") %>%
  mutate(tweet_type = ifelse(nature_word == 1, "nature tweet", "non-nature tweet"),
         nature_user = case_when(
            user_type == "local" & nature_word == 0 ~ "local, non nature tweet",
            user_type == "tourist" & nature_word == 0 ~ "tourist, non nature tweet",
            user_type == "tourist" & nature_word == 1 ~ "tourist, nature tweet",
            user_type == "local" & nature_word == 1 ~ "local, nature tweet"
        ))
```

Not surprisingly there are less nature-based tweets than nature-based. Of all `r nrow(data)` tweets, `r nrow(nature_df %>% filter(nature_word == 1))/nrow(data)*100`% are nature-based.

Of local tweeters, `r nrow(nature_df %>% filter(nature_word == 1, user_type == "local"))/nrow(nature_df %>% filter(user_type == "local"))*100`% of tweets are nature-based. Of tourists, `r nrow(nature_df %>% filter(nature_word == 1, user_type == "tourist"))/nrow(nature_df %>% filter(user_type == "tourist"))*100`% are nature-based.

```{r, echo = FALSE}
ggplot(nature_df_user_type, aes(x = tweet_type, fill = tweet_type)) +
  geom_bar() +
  theme_minimal() +
  labs(y = "# Tweets",
       x = "Type of tweet") +
  theme(legend.position = "none") +
  facet_wrap(~user_type) +
  scale_x_discrete(labels=c("Nature", "Non-nature")) +
  scale_fill_manual(values = c("darkgreen", "darkgray"))
```



## Are tweets in protected areas more often nature-based?

### California Protected Areas Database

# Time

## Timeline of tweets

Initial hypothesis was identifying spikes in nature-based tweets around three significant events:
- Refugio oil spill in 2015
- Thomas fire in 2017
- Debris flow in 2018

# Word clouds
top 100 words for locals vs tourist. And we could do this in space. At sterns wharf what are people tweeting about? At Elings, what are locals tweeting about?

![](figs/wordcloud_top_100_all_sb.png)

Maybe in word clouds we can see some changes due to natural events

## All of SB

## By area

# Sentiment Analysis


# Lessons learned

## Data is harder to find

# Future research

## Looking at different scale areas

There might be an interesting comparison between rural-suburban-urban areas. We hypothseize that the tourist/local alignment would split in urban areas, maybe aligned in suburban (like SB) and maybe not exist in rural.

Proportion of words that are nature based tells you how people. In Santa Barbara, there will be a lot of nature-based sense of place. In Manhattan, we wouldn’t expect to see nature based ones so much.

In a blog piece we can pose questions that we couldn’t answer but stuff like “can proportion of tourists/locals in place engagement tell us anything”.

Could compare % nature based tweets in SB to other areas. If we did this across the whole state, what proportion% are nature based? Maybe on average its just 5%.


Where and why do locals and tourists overlap in their use of area. SB seems to have a high alignment of tourists/locals, which may be helpful for local policy. Maybe places with distinct differences in how tourists/locals use places. 

Look at cities of different coastal sizes rural - small town - urban - mega city. Could see how tourists/locals patterns differentiate across scale. 

Is there a threshold of tourists where locals don’t go anymore? 

In areas where we see both tourists and locals engaging, what characteristics do we see? 

Quantifying transitions between rural to city. 