---
title: "04: Applying the dictionary"
author: "Jamie Montgomery"
output: 
  html_document:
    theme: paper
    toc: true
    toc_float: true
    toc_depth: 2
---
# Summary 

This script takes the geotagged twitter data and applies the dictionary to the tweets to identify whether or not each tweet is considered "nature-based".

## Setup

```{r setup, include=FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

library(tidyverse)
library(leaflet)
library(sf)
library(mapview)
library(RColorBrewer)
library(ggmap)
library(sp)
```

Load data
```{r}
data       <- read_csv("../data/tweets_nature_categorized.csv")
```


```{r}
nature_df <- data %>%
    mutate(coords = gsub("\\)|c\\(", "", geo_coordinates)) %>%
    separate(coords, c("lat", "lon"), sep = ", ") %>%
    mutate_at(c("lon", "lat"), as.numeric) %>% 
    st_as_sf(coords = c("lon", "lat")) %>%
    st_set_crs("+init=epsg:4326") %>%
  mutate(tweet_type = ifelse(nature_word == 1, "nature tweet", "non-nature tweet"),
         nature_user = case_when(
            user_type == "local" & nature_word == 0 ~ "local, non nature tweet",
            user_type == "tourist" & nature_word == 0 ~ "tourist, non nature tweet",
            user_type == "tourist" & nature_word == 1 ~ "tourist, nature tweet",
            user_type == "local" & nature_word == 1 ~ "local, nature tweet"
        ))
```

# Overlap with protected areas

Load california protected areas database
```{r}
cpad <- read_sf("../data/CPAD_2019a/CPAD_2019a_Holdings.shp") %>%
  filter(COUNTY == "Santa Barbara") %>%
  st_transform("+init=epsg:4326") %>%
  st_crop(xmin = -119.5, xmax = -120.5, ymin = 33.88, ymax = 34.6)
```

Map of CPAD areas in Santa Barbara
```{r}
cpad_map <- mapview(cpad, zcol = "UNIT_NAME", legend = FALSE)
cpad_map@map %>% setView(lng = -119.714, lat = 34.426, zoom = 13)

cpad_map
```

**How many tweets come from these areas?**

Count how many points in each polygon (all types of tweets not just nature based)

```{r}
cpad_nature_count <- cpad %>%
  mutate(pt_count = lengths(st_intersects(cpad, nature_df))) %>%
  filter(pt_count > 0)

mapview(cpad_nature_count ,zcol = "pt_count")@map %>% setView(lng = -119.714, lat = 34.426, zoom = 13)
```

Some of these areas overlap with high tourist areas (e.g. the Zoo and Wharf). Let's look at the content of these tweets to see how often tweets coming from these locations are nature-based or not.

# Compare occurrence of nature vs non-nature based tweets

```{r}
non_nature_tweets <- nature_df %>% 
  filter(nature_word == 0)

cpad_all_count <- cpad %>%
  mutate(nature_count = lengths(st_intersects(cpad, nature_df)),
         non_nature_count = lengths(st_intersects(cpad, non_nature_tweets))) %>%
  rowwise() %>%
  mutate(
         ratio = nature_count/non_nature_count,
         prop  = nature_count/sum(c(nature_count, non_nature_count))) %>%
  filter(!is.na(ratio)) %>%
  mutate(ratio = ifelse(is.infinite(ratio), nature_count, ratio)) %>% 
  st_set_geometry("geometry") %>%
  select(ACCESS_TYP, UNIT_NAME, SITE_NAME, MNG_AGNCY, nature_count, non_nature_count, ratio, prop)
```

**There is no site with less than `r min(cpad_all_count$prop)*100`% of tweets being nature-based.**

```{r}
mapview(cpad_all_count, zcol = "prop")

#mapshot(site_locations, file="sop_based_tweets.html")
```

Does this hold true over time?

Create a plot that shows proportion of nature-based tweets by site over time (might be too many, I would remove los padres forest)

```{r}

out <- data.frame()
for(i in 2015:2019){
  print(i)
  yr_tweets <- nature_df %>% filter(Year == i)
  yr_tweets_nn <- non_nature_tweets %>% filter(Year == i) #non-nature
  
cpad_by_year <- cpad %>%
  st_set_geometry(NULL) %>%
  mutate(nature_count = lengths(st_intersects(cpad, yr_tweets)),
         non_nature_count = lengths(st_intersects(cpad, yr_tweets_nn))) %>%
  rowwise() %>%
  mutate(
         ratio = nature_count/non_nature_count,
         prop  = nature_count/sum(c(nature_count, non_nature_count)),
         year = i) %>%
  filter(!is.na(ratio)) %>%
  mutate(ratio = ifelse(is.infinite(ratio), nature_count, ratio)) %>% 
  select(ACCESS_TYP, UNIT_NAME, SITE_NAME, MNG_AGNCY, nature_count, non_nature_count, ratio, prop, year)

out <- rbind(out, cpad_by_year)

}

```

Plot without los padres national fores
```{r}
ggplot(out %>% filter(SITE_NAME != "Los Padres National Forest"), 
       aes(x = year, y = prop, color = SITE_NAME)) +
  geom_line() +
  theme_minimal() +
  theme(legend.position = "none")
```
This is messy but what it shows is that no area has less than 50%. Let's look at sites with more than 1 tweet

```{r}
ggplot(out %>% filter(nature_count > 1), aes(x = SITE_NAME, fill = as.character(year), y = prop)) +
  geom_bar(stat = "identity", position = "dodge")

```
Look at sites that have tweets every year vs just once.

Interesting, SB Bowl has highest number of tweets but lower prop (around 50%) meaning only half tweets from there are nature based. Whereas carp state beach has 77% nature based (227 vs 69) in 2015.
